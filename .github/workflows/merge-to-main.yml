name: Merge Dev to Main

on:
  workflow_dispatch:
    inputs:
      merge_type:
        description: "Type of merge"
        required: true
        default: "merge"
        type: choice
        options:
          - merge
          - squash
          - rebase

jobs:
  merge:
    name: Merge Dev to Main
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check if dev is ahead of main
        id: check_ahead
        run: |
          git fetch origin main dev
          AHEAD=$(git rev-list --count origin/main..origin/dev)
          echo "commits_ahead=$AHEAD" >> $GITHUB_OUTPUT
          if [ "$AHEAD" -eq 0 ]; then
            echo "‚ùå Dev branch is not ahead of main. Nothing to merge."
            exit 1
          else
            echo "‚úÖ Dev is $AHEAD commits ahead of main"
          fi

      - name: Check for merge conflicts
        run: |
          git checkout main
          git pull origin main
          
          # Get merge base safely
          MERGE_BASE=$(git merge-base origin/main origin/dev)
          if [ -z "$MERGE_BASE" ]; then
            echo "‚ùå Unable to find merge base between main and dev"
            exit 1
          fi
          
          # Check for merge conflicts using git merge-tree
          MERGE_RESULT=$(git merge-tree "$MERGE_BASE" origin/main origin/dev)
          
          if echo "$MERGE_RESULT" | grep -q "^<<<<<<<"; then
            echo "‚ùå Merge conflicts detected. Please resolve conflicts manually."
            echo "Conflict markers found in merge result."
            exit 1
          elif [ -n "$MERGE_RESULT" ] && echo "$MERGE_RESULT" | grep -q "^@@"; then
            echo "‚ùå Merge conflicts detected. Please resolve conflicts manually."
            echo "Diff conflicts found in merge result."
            exit 1
          else
            echo "‚úÖ No merge conflicts detected"
          fi

      - name: Create Pull Request
        id: create_pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Ensure script has execute permissions
          chmod +x .github/scripts/create-merge-pr.sh
          
          # Run script and capture output safely
          set +e  # Temporarily disable exit on error to handle script output
          OUTPUT=$(.github/scripts/create-merge-pr.sh \
            "${{ steps.check_ahead.outputs.commits_ahead }}" \
            "${{ inputs.merge_type }}" \
            "${{ github.actor }}" \
            "${{ github.workflow }}" 2>&1)
          SCRIPT_EXIT_CODE=$?
          set -e  # Re-enable exit on error
          
          # Check if script succeeded
          if [ $SCRIPT_EXIT_CODE -ne 0 ]; then
            echo "‚ùå Script failed with exit code $SCRIPT_EXIT_CODE"
            echo "$OUTPUT"
            exit $SCRIPT_EXIT_CODE
          fi
          
          # Extract PR number safely
          PR_NUMBER=$(printf '%s\n' "$OUTPUT" | grep "^pr_number=" | head -n1 | cut -d'=' -f2)
          
          # Validate PR number was extracted
          if [ -z "$PR_NUMBER" ]; then
            echo "‚ùå Failed to extract PR number from script output"
            echo "Script output:"
            echo "$OUTPUT"
            exit 1
          fi
          
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "$OUTPUT"


      - name: Summary
        run: |
          echo "## üéâ Merge Process Initiated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **PR Number**: #${{ steps.create_pr.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commits to merge**: ${{ steps.check_ahead.outputs.commits_ahead }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Merge type**: ${{ inputs.merge_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ‚úÖ Ready for manual review and merge" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please review the PR and merge manually when ready." >> $GITHUB_STEP_SUMMARY

